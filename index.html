import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, query, onSnapshot, updateDoc, deleteDoc } from 'firebase/firestore';
// √çcone 'Whatsapp' removido da importa√ß√£o para corrigir o erro de compila√ß√£o.
import { Calendar, Clock, User, Phone, Save, MessageSquare, Loader, CheckCircle, AlertTriangle, XCircle, Info, Copy, Trash2 } from 'lucide-react';

// --- CONFIGURA√á√ïES E VARI√ÅVEIS GLOBAIS ---
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const API_KEY = ""; // Chave da API para a simula√ß√£o do Gemini
const MODEL_NAME = "gemini-2.5-flash-preview-05-20";

// --- FUN√á√ïES DE UTENS√çLIOS ---

/**
 * Converte a data e hora do agendamento para um objeto Date.
 * @param {string} dateString - Data no formato YYYY-MM-DD.
 * @param {string} timeString - Hora no formato HH:MM.
 * @returns {Date} Objeto Date.
 */
const getAppointmentDate = (dateString, timeString) => {
    if (!dateString || !timeString) return null;
    return new Date(`${dateString}T${timeString}:00`);
};

/**
 * Formata um objeto Date para a exibi√ß√£o de data e hora em portugu√™s.
 * @param {Date} date - Objeto Date.
 * @returns {string} Data e hora formatadas.
 */
const formatDateTime = (date) => {
    if (!date || isNaN(date)) return 'Data Inv√°lida';
    return date.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
};

/**
 * Retorna o caminho da cole√ß√£o de agendamentos (p√∫blica para colabora√ß√£o).
 * @param {string} currentAppId - O ID do aplicativo.
 * @returns {string} O caminho da cole√ß√£o.
 */
const getAppointmentCollectionPath = (currentAppId) =>
    `/artifacts/${currentAppId}/public/data/agendamentos`;

// --- SIMULA√á√ÉO DE ENVIO DE LEMBRETE VIA GEMINI API (com Backoff) ---

/**
 * Fun√ß√£o para simular o envio do lembrete via WhatsApp usando a API Gemini para gerar o texto.
 * @param {object} appointment - Dados do agendamento.
 * @param {object} db - Inst√¢ncia do Firestore.
 * @param {function} setFeedbackMessage - Fun√ß√£o para exibir a mensagem de feedback no App.
 * @param {number} attempt - Tentativa atual para backoff.
 */
const sendReminderSimulation = async (appointment, db, setFeedbackMessage, attempt = 0) => {
    const docRef = doc(db, getAppointmentCollectionPath(appId), appointment.id);

    try {
        // 1. Atualiza status para "enviando"
        await updateDoc(docRef, { reminderStatus: 'sending', reminderLog: 'Gerando texto...' });

        const formattedDate = formatDateTime(getAppointmentDate(appointment.date, appointment.time));
        
        const systemPrompt = "Voc√™ √© um assistente de agendamento profissional e amig√°vel. Sua √∫nica tarefa √© gerar o texto de um lembrete do WhatsApp em portugu√™s do Brasil. O tom deve ser direto, cort√™s e profissional. Mantenha o texto com no m√°ximo 2 frases. N√£o inclua emojis. N√£o inclua sauda√ß√µes ou despedidas, apenas o corpo da mensagem.";
        const userQuery = `Gere o lembrete para o cliente ${appointment.name}, com o telefone ${appointment.phone}, para o servi√ßo de ${appointment.service} agendado para ${formattedDate}.`;
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            config: {
                temperature: 0.5,
                maxOutputTokens: 100,
            }
        };

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erro na API Gemini: ${response.status} ${errorText}`);
        }

        const result = await response.json();
        const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Erro ao gerar texto de lembrete.";
        
        // 2. Cria o link do WhatsApp
        const whatsappLink = `https://wa.me/${appointment.phone.replace(/\D/g, '')}?text=${encodeURIComponent(generatedText)}`;

        // 3. ABRE O WHATSAPP IMEDIATAMENTE AP√ìS A GERA√á√ÉO DO TEXTO
        window.open(whatsappLink, '_blank');

        // Adiciona feedback visual imediato
        setFeedbackMessage({ 
            type: 'success', 
            text: 'Mensagem gerada! Se o WhatsApp n√£o abrir (restri√ß√£o de navegador), use o bot√£o "Copiar Link üîó" na lista de agendamentos.' 
        });
        
        // 4. Atualiza o status para "enviado" (com log do link aberto)
        await updateDoc(docRef, {
            reminderStatus: 'sent',
            reminderLog: `Lembrete (Simulado) Gerado e Enviado (Link Aberto): ${generatedText}`,
            whatsappLink: whatsappLink,
            sentAt: new Date().toISOString()
        });

    } catch (error) {
        if (attempt < 3) {
            const delay = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s
            console.warn(`Tentativa ${attempt + 1} falhou. Tentando novamente em ${delay}ms.`, error);
            await new Promise(resolve => setTimeout(resolve, delay));
            return sendReminderSimulation(appointment, db, setFeedbackMessage, attempt + 1);
        } else {
            console.error("Falha no envio do lembrete ap√≥s 3 tentativas.", error);
            await updateDoc(docRef, { 
                reminderStatus: 'failed', 
                reminderLog: `Falha na simula√ß√£o do envio: ${error.message}` 
            });
            setFeedbackMessage({ type: 'error', text: `Falha ao gerar o lembrete: ${error.message}` });
        }
    }
};

// --- COMPONENTE PRINCIPAL ---

const App = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [appointments, setAppointments] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [feedbackMessage, setFeedbackMessage] = useState(null); 
    const [appointmentToDelete, setAppointmentToDelete] = useState(null); // Estado para gerenciar a confirma√ß√£o de exclus√£o

    // Formul√°rio
    const [name, setName] = useState('');
    const [phone, setPhone] = useState('');
    const [date, setDate] = useState('');
    const [time, setTime] = useState('');
    const [service, setService] = useState('');
    const [formLoading, setFormLoading] = useState(false);
    
    // Novo estado para rastrear o status de c√≥pia do link
    const [copyStatus, setCopyStatus] = useState({});

    // Limpa a mensagem de feedback ap√≥s um tempo
    useEffect(() => {
        if (feedbackMessage) {
            const timer = setTimeout(() => setFeedbackMessage(null), 7000);
            return () => clearTimeout(timer);
        }
    }, [feedbackMessage]);

    // --- 1. INICIALIZA√á√ÉO E AUTENTICA√á√ÉO FIREBASE ---
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const authInstance = getAuth(app);

            setDb(firestore);
            setAuth(authInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    // Tenta autenticar
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(authInstance, initialAuthToken);
                        } else {
                            await signInAnonymously(authInstance);
                        }
                    } catch (e) {
                        setError(`Erro de Autentica√ß√£o: ${e.message}`);
                        console.error("Erro de autentica√ß√£o:", e);
                    }
                }
                setIsAuthReady(true);
                setLoading(false);
            });

            return () => unsubscribe();
        } catch (e) {
            setError(`Erro ao inicializar Firebase: ${e.message}`);
            setLoading(false);
        }
    }, []);

    // --- 2. CARREGAMENTO EM TEMPO REAL DOS AGENDAMENTOS (onSnapshot) ---
    useEffect(() => {
        if (!db || !isAuthReady) return;

        const appointmentsCollectionRef = collection(db, getAppointmentCollectionPath(appId));
        // Consulta para agendamentos futuros, ordenados por data
        const q = query(
            appointmentsCollectionRef,
            // N√£o usamos orderBy no Firestore para evitar erros de √≠ndice, ordenamos localmente.
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const loadedAppointments = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                // Converte a data do Firestore para o objeto Date para compara√ß√£o
                appointmentDateTime: getAppointmentDate(doc.data().date, doc.data().time)
            }));
            
            // Ordena localmente: Mais pr√≥ximos no topo
            loadedAppointments.sort((a, b) => a.appointmentDateTime - b.appointmentDateTime);
            setAppointments(loadedAppointments);
            setLoading(false);
        }, (err) => {
            setError(`Erro ao carregar agendamentos: ${err.message}`);
            setLoading(false);
        });

        return () => unsubscribe();
    }, [db, isAuthReady]);

    // --- 3. FUN√á√ÉO DE CADASTRO DE NOVO AGENDAMENTO ---
    const handleNewAppointment = async (e) => {
        e.preventDefault();
        // NOTA: O campo de telefone deve incluir o c√≥digo do pa√≠s e DDD, ex: 5511999998888
        if (!db || !name || !phone || !date || !time || !service) {
            setFeedbackMessage({ type: 'error', text: 'Por favor, preencha todos os campos obrigat√≥rios.' });
            return;
        }

        setFormLoading(true);
        setError(null);

        const newAppointmentData = {
            name: name.trim(),
            phone: phone.replace(/\D/g, ''), // Salva apenas n√∫meros (Deve incluir 55+DDD)
            date,
            time,
            service: service.trim(),
            createdAt: new Date().toISOString(),
            reminderStatus: 'pending', // Status inicial do lembrete
            reminderLog: 'Aguardando envio',
            userId
        };

        try {
            const appointmentsCollectionRef = collection(db, getAppointmentCollectionPath(appId));
            await setDoc(doc(appointmentsCollectionRef), newAppointmentData);
            
            // Limpa o formul√°rio ap√≥s o sucesso
            setName('');
            setPhone('');
            setDate('');
            setTime('');
            setService('');
            setFeedbackMessage({ type: 'success', text: 'Agendamento salvo com sucesso! Pronto para enviar o lembrete.' });

        } catch (e) {
            setError(`Erro ao salvar agendamento: ${e.message}`);
            setFeedbackMessage({ type: 'error', text: `Erro ao salvar agendamento: ${e.message}` });
        } finally {
            setFormLoading(false);
        }
    };

    // --- FUN√á√ÉO PARA DELETAR AGENDAMENTO ---
    const handleDeleteAppointment = async (id) => {
        if (!db) return;
        setFormLoading(true); // Usa o formLoading para indicar processamento
        setError(null);
        setAppointmentToDelete(null); // Fecha o modal de confirma√ß√£o

        try {
            const docRef = doc(db, getAppointmentCollectionPath(appId), id);
            await deleteDoc(docRef);
            setFeedbackMessage({ type: 'success', text: 'Agendamento deletado com sucesso.' });
        } catch (e) {
            setError(`Erro ao deletar agendamento: ${e.message}`);
            setFeedbackMessage({ type: 'error', text: `Erro ao deletar agendamento: ${e.message}` });
        } finally {
            setFormLoading(false);
        }
    };

    // --- FUN√á√ÉO PARA COPIAR LINK ---
    const copyToClipboard = (text, id) => {
        try {
            // Cria um campo de texto tempor√°rio para usar o comando execCommand
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            // document.execCommand('copy') √© usado para m√°xima compatibilidade em iframes
            document.execCommand('copy'); 
            document.body.removeChild(tempInput);
            
            setCopyStatus(prev => ({ ...prev, [id]: 'Link Copiado! ‚úÖ' }));
            setTimeout(() => setCopyStatus(prev => ({ ...prev, [id]: 'Copiar Link üîó' })), 3000);
        } catch (err) {
            console.error('Falha ao copiar:', err);
            setCopyStatus(prev => ({ ...prev, [id]: 'Erro ao Copiar' }));
            setTimeout(() => setCopyStatus(prev => ({ ...prev, [id]: 'Copiar Link üîó' })), 3000);
        }
    };


    // --- 4. RENDERIZA√á√ÉO DE COMPONENTES DE UI ---

    const ReminderStatusBadge = ({ status }) => {
        let classes = 'px-3 py-1 text-xs font-semibold rounded-full flex items-center';
        let icon = <Info className="w-3 h-3 mr-1" />;
        let text = 'Pendente';

        switch (status) {
            case 'pending':
                classes += ' bg-yellow-100 text-yellow-800';
                icon = <Clock className="w-3 h-3 mr-1" />;
                text = 'Aguardando';
                break;
            case 'sending':
                classes += ' bg-blue-100 text-blue-800 animate-pulse';
                icon = <Loader className="w-3 h-3 mr-1" />;
                text = 'Enviando...';
                break;
            case 'sent':
                classes += ' bg-green-100 text-green-800';
                icon = <CheckCircle className="w-3 h-3 mr-1" />;
                text = 'Enviado (Link Aberto)';
                break;
            case 'failed':
                classes += ' bg-red-100 text-red-800';
                icon = <AlertTriangle className="w-3 h-3 mr-1" />;
                text = 'Falha';
                break;
            default:
                classes += ' bg-gray-100 text-gray-800';
        }

        return (
            <span className={classes}>
                {icon}
                {text}
            </span>
        );
    };

    // √çcone SVG do WhatsApp (usado diretamente para evitar erro de importa√ß√£o)
    const WhatsappIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="w-3 h-3 mr-1" viewBox="0 0 448 512" fill="currentColor">
            <path d="M380.9 97.1C339.4 55.4 283.4 32 224 32S108.6 55.4 67.1 97.1 32 183.4 32 242s23.4 134.9 67.1 176.7L32 480l113.8-37.5c39.6 22.8 84.7 35.8 131.2 35.8 59.4 0 115.4-23.4 156.9-65.1S416 301.4 416 242s-23.4-115.9-67.1-157.1zm-86 238l-4.4 7.2c-15.6 24.8-40.1 36.1-66.2 36.1-23.3 0-46.7-6.2-67.6-17.9-20.9-11.7-37.9-28.7-49.6-49.6-11.7-20.9-17.9-44.3-17.9-67.6 0-26.1 11.3-50.6 36.1-66.2l7.2-4.4c.6-.4 1.2-.6 1.8-.8s1.2-.4 1.8-.4c1.2 0 2.4.4 3.5 1.1l39.5 22.8c2.4 1.4 4.1 3.4 5.2 5.8s1.6 4.9 1.6 7.4c0 3.3-1.3 6.6-3.7 9.1L200 248.8l-15.6 15.6c-2.4 2.4-5.6 3.7-9.1 3.7s-6.6-1.3-9.1-3.7l-7.2-7.2c-2.4-2.4-5.6-3.7-9.1-3.7s-6.6 1.3-9.1 3.7l-22.8 22.8c-2.4 2.4-3.7 5.6-3.7 9.1s1.3 6.6 3.7 9.1l45.9 45.9c.7.7 1.4 1.4 2.1 2.1 1.7 1.7 3.6 3.2 5.7 4.5 2.1 1.3 4.3 2.4 6.6 3.4s4.7 1.6 7.1 1.9c.2.2.4.4.6.6 .9.9 1.9 1.7 3 2.4 1 .6 2.1 1.1 3.2 1.5s2.2.8 3.3 1c.2.2.4.4.6.6 .9.9 1.9 1.7 3 2.4 1 .6 2.1 1.1 3.2 1.5s2.2.8 3.3 1c1.2.2 2.4.3 3.6.3 3.3 0 6.6-1.3 9.1-3.7l15.6-15.6c2.4-2.4 3.7-5.6 3.7-9.1s-1.3-6.6-3.7-9.1l-4.4-7.2c-1.3-2.1-1.7-4.5-1.1-6.9 0-.2.2-.4.4-.6l22.8-22.8c2.4-2.4 5.6-3.7 9.1-3.7s6.6 1.3 9.1 3.7l15.6 15.6c2.4 2.4 5.6 3.7 9.1 3.7s6.6-1.3 9.1-3.7l4.4-7.2c2.4-2.4 3.7-5.6 3.7-9.1s-1.3-6.6-3.7-9.1z"/>
        </svg>
    );

    // --- RENDERIZA√á√ÉO PRINCIPAL ---
    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-slate-50">
                <Loader className="w-8 h-8 text-blue-500 animate-spin" />
                <p className="ml-2 text-slate-700">Carregando Sistema...</p>
            </div>
        );
    }

    const appToDeleteData = appointmentToDelete ? appointments.find(app => app.id === appointmentToDelete) : null;

    return (
        <div className="min-h-screen bg-slate-50 font-sans p-4 sm:p-8">
            <script src="https://cdn.tailwindcss.com"></script>
            <style>
                {`
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
                body { font-family: 'Inter', sans-serif; }
                .card { transition: all 0.3s ease; }
                .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
                input[type="date"]::-webkit-calendar-picker-indicator,
                input[type="time"]::-webkit-calendar-picker-indicator {
                    cursor: pointer;
                }
                `}
            </style>
            
            {/* Modal de Confirma√ß√£o de Exclus√£o */}
            {appointmentToDelete && appToDeleteData && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                        <h3 className="text-xl font-bold text-red-600 mb-4 flex items-center">
                            <Trash2 className="w-6 h-6 mr-2" /> Confirmar Exclus√£o
                        </h3>
                        <p className="text-slate-700 mb-4">
                            Voc√™ tem certeza que deseja deletar o agendamento de **{appToDeleteData.name}** para **{appToDeleteData.service}** em **{formatDateTime(appToDeleteData.appointmentDateTime)}**?
                        </p>
                        <p className="text-sm text-red-500 mb-6">Esta a√ß√£o n√£o pode ser desfeita.</p>
                        <div className="flex justify-end space-x-3">
                            <button
                                onClick={() => setAppointmentToDelete(null)}
                                className="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 transition"
                                disabled={formLoading}
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={() => handleDeleteAppointment(appointmentToDelete)}
                                className={`px-4 py-2 text-white font-semibold rounded-lg shadow-md transition ${formLoading ? 'bg-red-400 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700'}`}
                                disabled={formLoading}
                            >
                                {formLoading ? 'Deletando...' : 'Sim, Deletar'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            <header className="mb-8 text-center">
                <h1 className="text-3xl sm:text-4xl font-extrabold text-slate-800">
                    Agenda Inteligente üóìÔ∏è
                </h1>
                <p className="text-slate-500 mt-1">
                    Cadastre agendamentos e envie lembretes autom√°ticos via WhatsApp.
                </p>
                <div className="mt-4 p-2 bg-blue-100 text-blue-700 rounded-lg text-sm flex items-start justify-center">
                    <Info className="w-4 h-4 mt-0.5 mr-2 flex-shrink-0" />
                    <span>
                        **Aviso de Seguran√ßa:** O bot√£o **"Enviar Lembrete Agora"** tenta abrir o WhatsApp. Se falhar, √© devido √† restri√ß√£o de pop-up do seu navegador. **Use o bot√£o "Copiar Link"** para enviar manualmente.
                    </span>
                </div>
            </header>
            
            {/* Mensagem de Feedback (Nova) */}
            {feedbackMessage && (
                <div className={`fixed top-4 right-4 z-50 p-4 rounded-xl shadow-lg transition-opacity duration-300 ${feedbackMessage.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} flex items-center`}>
                    {feedbackMessage.type === 'success' ? <CheckCircle className="w-5 h-5 mr-3" /> : <XCircle className="w-5 h-5 mr-3" />}
                    <p className="font-medium">{feedbackMessage.text}</p>
                </div>
            )}
            
            {error && (
                <div className="mb-4 p-4 bg-red-100 text-red-700 rounded-xl flex items-center shadow-md">
                    <XCircle className="w-5 h-5 mr-3" />
                    <p className="font-medium">Ocorreu um erro: {error}</p>
                </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* COLUNA 1: CADASTRO DE AGENDAMENTO */}
                <div className="lg:col-span-1 card bg-white p-6 rounded-2xl shadow-xl h-fit">
                    <h2 className="text-xl font-bold text-slate-800 mb-6 border-b pb-2">Novo Agendamento</h2>
                    <form onSubmit={handleNewAppointment} className="space-y-4">
                        
                        <div>
                            <label htmlFor="name" className="block text-sm font-medium text-slate-700 mb-1">Nome do Cliente</label>
                            <div className="relative">
                                <User className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
                                <input
                                    id="name"
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="Ex: Ana Silva"
                                    className="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                    required
                                />
                            </div>
                        </div>

                        <div>
                            <label htmlFor="phone" className="block text-sm font-medium text-slate-700 mb-1">Telefone (Ex: 5511999998888)</label>
                            <div className="relative">
                                <Phone className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
                                <input
                                    id="phone"
                                    type="tel"
                                    value={phone}
                                    onChange={(e) => setPhone(e.target.value)}
                                    placeholder="Use c√≥digo do pa√≠s + DDD + n√∫mero"
                                    className="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                    required
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label htmlFor="date" className="block text-sm font-medium text-slate-700 mb-1">Data</label>
                                <div className="relative">
                                    <Calendar className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
                                    <input
                                        id="date"
                                        type="date"
                                        value={date}
                                        onChange={(e) => setDate(e.target.value)}
                                        className="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                        required
                                    />
                                </div>
                            </div>
                            <div>
                                <label htmlFor="time" className="block text-sm font-medium text-slate-700 mb-1">Hora</label>
                                <div className="relative">
                                    <Clock className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
                                    <input
                                        id="time"
                                        type="time"
                                        value={time}
                                        onChange={(e) => setTime(e.target.value)}
                                        className="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                        required
                                    />
                                </div>
                            </div>
                        </div>

                        <div>
                            <label htmlFor="service" className="block text-sm font-medium text-slate-700 mb-1">Servi√ßo/Tratamento</label>
                            <div className="relative">
                                <MessageSquare className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
                                <input
                                    id="service"
                                    type="text"
                                    value={service}
                                    onChange={(e) => setService(e.target.value)}
                                    placeholder="Ex: Corte de Cabelo / Limpeza de Pele"
                                    className="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                    required
                                />
                            </div>
                        </div>

                        <button
                            type="submit"
                            className={`w-full flex items-center justify-center px-4 py-2 text-white font-semibold rounded-lg shadow-lg transition duration-300 
                            ${formLoading ? 'bg-blue-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                            disabled={formLoading}
                        >
                            {formLoading ? (
                                <>
                                    <Loader className="w-5 h-5 mr-2 animate-spin" />
                                    Salvando...
                                </>
                            ) : (
                                <>
                                    <Save className="w-5 h-5 mr-2" />
                                    Salvar Agendamento
                                </>
                            )}
                        </button>
                    </form>
                </div>

                {/* COLUNA 2/3: LISTA DE AGENDAMENTOS */}
                <div className="lg:col-span-2 card bg-white p-6 rounded-2xl shadow-xl">
                    <h2 className="text-xl font-bold text-slate-800 mb-6 border-b pb-2 flex justify-between items-center">
                        Pr√≥ximos Agendamentos ({appointments.length})
                        <span className="text-sm font-normal text-slate-500">Logado como: {userId ? userId.substring(0, 8) + '...' : 'An√¥nimo'}</span>
                    </h2>

                    {appointments.length === 0 ? (
                        <div className="p-10 text-center text-slate-500">
                            <Calendar className="w-12 h-12 mx-auto mb-3 text-slate-300" />
                            <p>Nenhum agendamento futuro encontrado. Cadastre um!</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {appointments.map((app) => (
                                <div key={app.id} className="p-4 border border-slate-200 rounded-xl shadow-sm bg-slate-50">
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <p className="text-lg font-bold text-slate-800">{app.name} ({app.phone})</p>
                                            <p className="text-sm text-blue-600 font-medium">{app.service}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-base font-semibold text-slate-700">
                                                {formatDateTime(app.appointmentDateTime)}
                                            </p>
                                            <ReminderStatusBadge status={app.reminderStatus} />
                                        </div>
                                    </div>

                                    <div className="mt-3 pt-3 border-t border-slate-100 text-sm">
                                        <p className="font-semibold text-slate-700">Log do Lembrete:</p>
                                        <p className="text-slate-600 italic">
                                            {app.reminderLog}
                                        </p>
                                    </div>

                                    <div className="mt-3 flex flex-wrap gap-3">
                                        {/* Bot√£o Enviar Lembrete */}
                                        <button
                                            onClick={() => sendReminderSimulation(app, db, setFeedbackMessage)}
                                            className={`flex items-center text-xs font-medium px-3 py-1 rounded-full transition duration-150 
                                                ${app.reminderStatus === 'sending' ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}
                                            disabled={app.reminderStatus === 'sending'}
                                        >
                                            <WhatsappIcon />
                                            {app.reminderStatus === 'sending' ? 'Processando...' : 'Enviar Lembrete Agora'}
                                        </button>

                                        {/* Bot√£o Copiar Link */}
                                        {app.whatsappLink && app.reminderStatus !== 'sending' && (
                                            <button
                                                onClick={() => copyToClipboard(app.whatsappLink, app.id)}
                                                className="flex items-center text-xs font-medium px-3 py-1 rounded-full bg-slate-200 text-slate-800 hover:bg-slate-300 transition duration-150"
                                            >
                                                <Copy className='w-3 h-3 mr-1'/>
                                                {copyStatus[app.id] === 'Link Copiado! ‚úÖ' ? 'Link Copiado! ‚úÖ' : 'Copiar Link üîó'}
                                            </button>
                                        )}

                                        {/* Novo Bot√£o Deletar */}
                                        <button
                                            onClick={() => setAppointmentToDelete(app.id)}
                                            className="flex items-center text-xs font-medium px-3 py-1 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition duration-150"
                                            disabled={formLoading} // Desativa se j√° estiver processando (salvar/deletar)
                                        >
                                            <Trash2 className='w-3 h-3 mr-1'/>
                                            Deletar
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

export default App;
